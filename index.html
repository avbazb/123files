<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æ”¶é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        .folder-info {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .folder-info h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .folder-info p {
            margin: 0.5rem 0 0;
            color: #666;
        }
        .upload-tip {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .file-item {
            position: relative;
            padding-right: 100px;
        }
        .file-status {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .cancel-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
        .file-icon {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
        }
        .file-info {
            display: flex;
            align-items: center;
        }
        .pending-file-list {
            margin-top: 1rem;
            text-align: left;
        }
        .pending-file-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .pending-file-item .file-name {
            flex: 1;
            margin-right: 1rem;
        }
        .pending-file-item .remove-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="folder-info">
            <h1 id="folderName">æ–‡ä»¶å¤¹åˆ—è¡¨</h1>
            <p id="folderDesc">è¯·é€‰æ‹©è¦è®¿é—®çš„æ–‡ä»¶å¤¹</p>
        </div>

        <div class="folder-list" id="folderList">
            <!-- æ–‡ä»¶å¤¹åˆ—è¡¨å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
        </div>

        <div class="upload-area hidden" id="uploadArea">
            <h2>æ–‡ä»¶ä¸Šä¼ </h2>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
            <input type="file" id="fileInput" multiple style="display: none">
            <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
            <p class="upload-tip">é€‰æ‹©çš„æ–‡ä»¶å°†æ˜¾ç¤ºåœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»"å¼€å§‹ä¸Šä¼ "æŒ‰é’®å¼€å§‹ä¸Šä¼ </p>
            
            <div id="pendingFileList" class="pending-file-list" style="margin-top: 1rem;">
                <!-- å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
            </div>
            
            <div class="upload-actions" style="margin-top: 1rem; text-align: center;">
                <button class="btn" id="startUploadBtn" onclick="startUpload()" style="display: none;">å¼€å§‹ä¸Šä¼ </button>
            </div>
        </div>

        <div class="file-list hidden" id="fileList">
            <!-- å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
        </div>
    </div>

    <div class="modal hidden" id="passwordModal">
        <div class="modal-content">
            <h3>è¯·è¾“å…¥æ–‡ä»¶å¤¹å¯†ç </h3>
            <p id="passwordDesc" style="color: #666; margin-bottom: 1rem;"></p>
            <div class="form-group">
                <input type="password" id="folderPassword" placeholder="è¯·è¾“å…¥å¯†ç " autofocus>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal('passwordModal')">å–æ¶ˆ</button>
                <button class="btn" onclick="submitPassword()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/upload.js"></script>
    <script>
        // è·å–DOMå…ƒç´ 
        const container = document.querySelector('.container');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const folderList = document.getElementById('folderList');
        const passwordModal = document.getElementById('passwordModal');
        const folderPassword = document.getElementById('folderPassword');
        
        let currentFolderID = 0;
        let pendingFiles = [];

        // åˆå§‹åŒ–
        async function init() {
            try {
                // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.add('hidden');
                });

                // è·å–URLå‚æ•°ä¸­çš„æ–‡ä»¶å¤¹ID
                const urlParams = new URLSearchParams(window.location.search);
                const folderID = urlParams.get('folder');

                if (folderID) {
                    // å¦‚æœURLä¸­æœ‰æ–‡ä»¶å¤¹IDï¼Œå°è¯•è¿›å…¥è¯¥æ–‡ä»¶å¤¹
                    await enterFolder(parseInt(folderID));
                } else {
                    // å¦åˆ™æ˜¾ç¤ºæ–‡ä»¶å¤¹åˆ—è¡¨
                    await loadFolderList();
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
        async function loadFolderList() {
            try {
                const folders = await api.getFileList(0);
                folderList.innerHTML = '';

                folders.fileList.forEach(folder => {
                    if (folder.type === 1) {
                        const folderItem = document.createElement('div');
                        folderItem.className = 'folder-item';
                        folderItem.style.cursor = 'pointer';
                        folderItem.style.padding = '1rem';
                        folderItem.style.borderRadius = '8px';
                        folderItem.style.marginBottom = '0.5rem';
                        folderItem.style.background = 'white';
                        folderItem.style.display = 'flex';
                        folderItem.style.alignItems = 'center';
                        folderItem.innerHTML = `
                            <span style="margin-right: 0.5rem">ğŸ“</span>
                            <div style="flex: 1">${folder.filename}</div>
                            <button class="btn" onclick="enterFolder(${folder.fileId})">è¿›å…¥</button>
                        `;
                        folderList.appendChild(folderItem);
                    }
                });

                // æ˜¾ç¤ºæ–‡ä»¶å¤¹åˆ—è¡¨ï¼Œéšè—ä¸Šä¼ åŒºåŸŸ
                folderList.classList.remove('hidden');
                uploadArea.classList.add('hidden');
                fileList.classList.add('hidden');
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // è¿›å…¥æ–‡ä»¶å¤¹
        async function enterFolder(folderID) {
            try {
                // æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦éœ€è¦å¯†ç 
                const password = await api.getFolderPassword(folderID);
                if (password) {
                    currentFolderID = folderID;
                    const folders = await api.getFileList(0);
                    const folder = folders.fileList.find(f => f.fileId === folderID);
                    document.getElementById('passwordDesc').textContent = 
                        `æ–‡ä»¶å¤¹"${folder.filename}"å—å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥å¯†ç ç»§ç»­è®¿é—®`;
                    passwordModal.classList.remove('hidden');
                    return;
                }

                // ä¸éœ€è¦å¯†ç ï¼Œç›´æ¥è¿›å…¥
                await showUploadArea(folderID);
            } catch (error) {
                console.error('è¿›å…¥æ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('è¿›å…¥æ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
        async function showUploadArea(folderID) {
            try {
                currentFolderID = folderID;
                const folders = await api.getFileList(0);
                const folder = folders.fileList.find(f => f.fileId === folderID);

                if (folder) {
                    document.getElementById('folderName').textContent = folder.filename;
                    document.getElementById('folderDesc').textContent = 
                        'è¯·å°†æ–‡ä»¶æ‹–æ”¾åˆ°ä¸‹æ–¹åŒºåŸŸæˆ–ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®è¿›è¡Œä¸Šä¼ ';
                    
                    // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸï¼Œéšè—æ–‡ä»¶å¤¹åˆ—è¡¨
                    folderList.classList.add('hidden');
                    uploadArea.classList.remove('hidden');
                    fileList.classList.remove('hidden');

                    // åŠ è½½å½“å‰æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
                    await loadCurrentFolderFiles(folderID);
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸå¤±è´¥:', error);
                alert('æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸå¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å½“å‰æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
        async function loadCurrentFolderFiles(folderID) {
            try {
                const files = await api.getFileList(folderID);
                const fileListDiv = document.getElementById('fileList');
                fileListDiv.innerHTML = '<h3>æ–‡ä»¶å¤¹å†…å®¹ï¼š</h3>';

                if (files.fileList && files.fileList.length > 0) {
                    const fileItems = files.fileList
                        .filter(file => file.type === 0)  // åªæ˜¾ç¤ºæ–‡ä»¶ï¼Œä¸æ˜¾ç¤ºæ–‡ä»¶å¤¹
                        .map(file => `
                            <div class="file-item" style="display: flex; align-items: center; padding: 10px; background: white; margin: 5px 0; border-radius: 8px;">
                                <span class="file-icon" style="margin-right: 10px;">${getFileIcon(file.filename)}</span>
                                <div class="file-info" style="flex: 1;">
                                    <div class="file-name">${file.filename}</div>
                                    <div style="color: #666; font-size: 0.9em;">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                        `).join('');

                    fileListDiv.innerHTML += fileItems;
                } else {
                    fileListDiv.innerHTML += '<p style="color: #666; text-align: center; padding: 20px;">æ–‡ä»¶å¤¹ä¸ºç©º</p>';
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†å¯†ç éªŒè¯
        async function submitPassword() {
            const password = folderPassword.value;
            const correctPassword = await api.getFolderPassword(currentFolderID);
            
            if (password === correctPassword) {
                hideModal('passwordModal');
                await showUploadArea(currentFolderID);
                
                // å¤„ç†ç­‰å¾…ä¸Šä¼ çš„æ–‡ä»¶
                if (pendingFiles.length > 0) {
                    handleFiles(pendingFiles);
                    pendingFiles = [];
                }
            } else {
                alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                // æ¸…ç©ºè¾“å…¥
                const inputs = modal.querySelectorAll('input');
                inputs.forEach(input => input.value = '');
            }
        }

        // æ–‡ä»¶æ‹–æ”¾å¤„ç†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            addToPendingList(e.dataTransfer.files);
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', () => {
            addToPendingList(fileInput.files);
            fileInput.value = '';
        });

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFiles(files) {
            const fileListDiv = document.getElementById('fileList');
            for (const file of files) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.filename = file.name; // æ·»åŠ æ–‡ä»¶åæ ‡è¯†
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(file.name)}</span>
                        <div class="file-name">${file.name}</div>
                        <div style="margin-left: 1rem; color: #666;">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="file-status">
                        <span class="status-text">å‡†å¤‡ä¸Šä¼ </span>
                        <button class="cancel-btn" onclick="cancelUpload('${file.name}')">å–æ¶ˆ</button>
                    </div>
                `;
                fileListDiv.appendChild(fileItem);

                try {
                    const fileID = await uploadManager.addUpload(file, currentFolderID);
                    const successItem = document.querySelector(`.file-item[data-filename="${file.name}"]`);
                    if (successItem) {
                        successItem.querySelector('.file-status').innerHTML = `
                            <span class="success">ä¸Šä¼ æˆåŠŸ</span>
                        `;
                    }
                } catch (error) {
                    if (!uploadManager.uploads.get(file.name)?.aborted) {
                        const errorItem = document.querySelector(`.file-item[data-filename="${file.name}"]`);
                        if (errorItem) {
                            errorItem.querySelector('.file-status').innerHTML = `
                                <span class="error">ä¸Šä¼ å¤±è´¥: ${error.message}</span>
                                <button class="btn" onclick="retryUpload(this, '${file.name}')">é‡è¯•</button>
                            `;
                        }
                    }
                }
            }
        }

        // å–æ¶ˆä¸Šä¼ 
        function cancelUpload(filename) {
            uploadManager.cancelUpload(filename);
        }

        // é‡è¯•ä¸Šä¼ 
        async function retryUpload(btn, filename) {
            const fileItem = btn.closest('.file-item');
            const file = Array.from(pendingFiles).find(f => f.name === filename) || 
                        Array.from(fileInput.files).find(f => f.name === filename);
            
            if (file) {
                fileItem.querySelector('.file-status').innerHTML = `
                    å‡†å¤‡ä¸Šä¼ 
                    <button class="cancel-btn" onclick="cancelUpload('${filename}')">å–æ¶ˆ</button>
                `;
                fileItem.querySelector('.progress-bar').style.width = '0%';
                await handleFiles([file]);
            } else {
                alert('æ‰¾ä¸åˆ°åŸå§‹æ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶ä¸Šä¼ ');
            }
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                pdf: 'ğŸ“„',
                doc: 'ğŸ“', docx: 'ğŸ“',
                xls: 'ğŸ“Š', xlsx: 'ğŸ“Š',
                ppt: 'ğŸ“½', pptx: 'ğŸ“½',
                jpg: 'ğŸ–¼', jpeg: 'ğŸ–¼', png: 'ğŸ–¼', gif: 'ğŸ–¼',
                zip: 'ğŸ“¦', rar: 'ğŸ“¦', '7z': 'ğŸ“¦',
                mp3: 'ğŸµ', wav: 'ğŸµ',
                mp4: 'ğŸ¥', avi: 'ğŸ¥', mov: 'ğŸ¥'
            };
            return icons[ext] || 'ğŸ“„';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }

        // ä¸Šä¼ è¿›åº¦æ›´æ–°
        window.addEventListener('uploadProgress', (e) => {
            const { filename, progress, status, uploadedSize, totalSize, speed } = e.detail;
            const fileItem = document.querySelector(`.file-item[data-filename="${filename}"]`);
            if (fileItem) {
                fileItem.querySelector('.progress-bar').style.width = `${progress}%`;
                
                // æ ¼å¼åŒ–ä¸Šä¼ ä¿¡æ¯
                let statusText = status;
                if (uploadedSize !== undefined && totalSize !== undefined) {
                    const uploadedSizeStr = formatFileSize(uploadedSize);
                    const totalSizeStr = formatFileSize(totalSize);
                    statusText += ` (${uploadedSizeStr}/${totalSizeStr})`;
                    
                    // æ·»åŠ é€Ÿåº¦ä¿¡æ¯
                    if (speed > 0) {
                        const speedStr = formatFileSize(speed) + '/s';
                        statusText += ` - ${speedStr}`;
                    }
                }
                
                fileItem.querySelector('.status-text').textContent = statusText;
            }
        });

        // ä¸Šä¼ å–æ¶ˆäº‹ä»¶
        window.addEventListener('uploadCancelled', (e) => {
            const { filename } = e.detail;
            const fileItem = document.querySelector(`.file-item[data-filename="${filename}"]`);
            if (fileItem) {
                fileItem.querySelector('.file-status').innerHTML = `
                    <span class="error">å·²å–æ¶ˆä¸Šä¼ </span>
                    <button class="btn" onclick="retryUpload(this, '${filename}')">é‡è¯•</button>
                `;
            }
        });

        // æ·»åŠ åˆ°å¾…ä¸Šä¼ åˆ—è¡¨
        function addToPendingList(files) {
            const pendingList = document.getElementById('pendingFileList');
            const startUploadBtn = document.getElementById('startUploadBtn');
            
            Array.from(files).forEach(file => {
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²åœ¨åˆ—è¡¨ä¸­
                if (!pendingFiles.some(f => f.name === file.name)) {
                    pendingFiles.push(file);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'pending-file-item';
                    fileItem.innerHTML = `
                        <span class="file-icon">${getFileIcon(file.name)}</span>
                        <div class="file-name">${file.name}</div>
                        <div style="color: #666;">${formatFileSize(file.size)}</div>
                        <button class="remove-btn" onclick="removeFromPendingList('${file.name}')">ç§»é™¤</button>
                    `;
                    pendingList.appendChild(fileItem);
                }
            });

            // æ˜¾ç¤ºæˆ–éšè—ä¸Šä¼ æŒ‰é’®
            startUploadBtn.style.display = pendingFiles.length > 0 ? 'inline-block' : 'none';
        }

        // ä»å¾…ä¸Šä¼ åˆ—è¡¨ç§»é™¤
        function removeFromPendingList(filename) {
            pendingFiles = pendingFiles.filter(file => file.name !== filename);
            const pendingList = document.getElementById('pendingFileList');
            const fileItem = Array.from(pendingList.children).find(
                item => item.querySelector('.file-name').textContent === filename
            );
            if (fileItem) {
                pendingList.removeChild(fileItem);
            }

            // æ›´æ–°ä¸Šä¼ æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            document.getElementById('startUploadBtn').style.display = 
                pendingFiles.length > 0 ? 'inline-block' : 'none';
        }

        // å¼€å§‹ä¸Šä¼ 
        async function startUpload() {
            const startUploadBtn = document.getElementById('startUploadBtn');
            startUploadBtn.disabled = true;
            
            try {
                for (const file of pendingFiles) {
                    await handleFiles([file]);
                }
                // æ¸…ç©ºå¾…ä¸Šä¼ åˆ—è¡¨
                pendingFiles = [];
                document.getElementById('pendingFileList').innerHTML = '';
                startUploadBtn.style.display = 'none';
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
            } finally {
                startUploadBtn.disabled = false;
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        init();
    </script>
</body>
</html> 