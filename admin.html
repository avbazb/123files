<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æ”¶é›†ç³»ç»Ÿ - ç®¡ç†æ§åˆ¶å°</title>
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
    .hidden {
        display: none !important;
    }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>æ–‡ä»¶å¤¹</h2>
        <button class="btn" onclick="showCreateFolderModal()">åˆ›å»ºæ–‡ä»¶å¤¹</button>
        <div class="folder-list" id="folderList">
            <!-- æ–‡ä»¶å¤¹åˆ—è¡¨å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
        </div>
    </div>

    <div class="main-content">
        <div class="toolbar">
            <div class="search-box">
                <input type="text" placeholder="æœç´¢æ–‡ä»¶..." id="searchInput">
            </div>
            <div>
                <button class="btn" onclick="downloadSelected()">æ‰¹é‡ä¸‹è½½</button>
                <button class="btn btn-secondary" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button>
            </div>
        </div>

        <div class="file-grid" id="fileGrid">
            <!-- æ–‡ä»¶åˆ—è¡¨å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
        </div>
    </div>

    <!-- åˆ›å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div class="modal hidden" id="createFolderModal" onclick="hideModal('createFolderModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>åˆ›å»ºæ–‡ä»¶å¤¹</h3>
            <div class="form-group">
                <label>æ–‡ä»¶å¤¹åç§°</label>
                <input type="text" id="newFolderName" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
            </div>
            <div class="form-group">
                <label>è®¿é—®å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                <input type="password" id="newFolderPassword" placeholder="ä¸è®¾ç½®åˆ™æ— éœ€å¯†ç ">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal('createFolderModal')">å–æ¶ˆ</button>
                <button class="btn" onclick="createFolder()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶å¤¹è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal hidden" id="folderSettingsModal" style="display:none;" onclick="hideModal('folderSettingsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>æ–‡ä»¶å¤¹è®¾ç½®</h3>
            <div class="form-group">
                <label>æ–‡ä»¶å¤¹åç§°</label>
                <input type="text" id="editFolderName">
            </div>
            <div class="form-group">
                <label>è®¿é—®å¯†ç </label>
                <input type="password" id="editFolderPassword" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç ">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="removePassword">
                <label for="removePassword">åˆ é™¤å¯†ç ï¼ˆå…è®¸å…¬å¼€è®¿é—®ï¼‰</label>
            </div>
            <div class="form-group">
                <label>åˆ†äº«é“¾æ¥</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="shareLink" readonly style="flex: 1;">
                    <button class="btn btn-secondary" onclick="copyShareLink()">å¤åˆ¶</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal('folderSettingsModal')">å–æ¶ˆ</button>
                <button class="btn" onclick="saveFolderSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentFolderID = 0;
        let selectedFiles = new Set();

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const visibleModal = document.querySelector('.modal:not(.hidden)');
                if (visibleModal) {
                    hideModal(visibleModal.id);
                }
            }
        });

        // æ˜¾ç¤ºåˆ›å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†
        function showCreateFolderModal() {
            const modal = document.getElementById('createFolderModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.getElementById('newFolderName').value = '';
            document.getElementById('newFolderPassword').value = '';
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.add('hidden');
                });

                // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
                await loadFolders();
                await loadFiles(currentFolderID);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
        async function loadFolders() {
            try {
                const folderList = document.getElementById('folderList');
                const folders = await api.getFileList(0);
                
                folderList.innerHTML = `
                    <div class="folder-item ${currentFolderID === 0 ? 'active' : ''}" 
                         onclick="selectFolder(0)">
                        <div class="folder-name">æ ¹ç›®å½•</div>
                    </div>
                `;

                folders.fileList.forEach(folder => {
                    if (folder.type === 1) {
                        folderList.innerHTML += `
                            <div class="folder-item ${folder.fileId === currentFolderID ? 'active' : ''}"
                                 onclick="selectFolder(${folder.fileId})">
                                <div class="folder-name">${folder.filename}</div>
                                <div class="folder-actions">
                                    <button class="action-btn" onclick="showFolderSettings(${folder.fileId})">
                                        âš™ï¸
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles(folderID) {
            try {
                const fileGrid = document.getElementById('fileGrid');
                const files = await api.getFileList(folderID);
                
                fileGrid.innerHTML = '';
                selectedFiles.clear();

                files.fileList.forEach(file => {
                    if (file.type === 0) {
                        fileGrid.innerHTML += `
                            <div class="file-card" data-file-id="${file.fileId}">
                                <div class="file-actions">
                                    <input type="checkbox" onchange="toggleFileSelection(${file.fileId})">
                                </div>
                                <div class="file-icon">${getFileIcon(file.filename)}</div>
                                <div class="file-name">${file.filename}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                <button class="btn" onclick="downloadFile(${file.fileId})">ä¸‹è½½</button>
                            </div>
                        `;
                    }
                });
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
                alert('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        // é€‰æ‹©æ–‡ä»¶å¤¹
        async function selectFolder(folderID) {
            currentFolderID = folderID;
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.folder-item[onclick*="${folderID}"]`).classList.add('active');
            await loadFiles(folderID);
        }

        // æ˜¾ç¤ºæ–‡ä»¶å¤¹è®¾ç½®
        async function showFolderSettings(folderID) {
            try {
                const folders = await api.getFileList(0);
                const folder = folders.fileList.find(f => f.fileId === folderID);
                if (folder) {
                    const modal = document.getElementById('folderSettingsModal');
                    modal.dataset.folderId = folderID;
                    modal.querySelector('#editFolderName').value = folder.filename;
                    
                    // ç”Ÿæˆåˆ†äº«é“¾æ¥
                    const shareUrl = `${window.location.origin}/index.html?folder=${folderID}`;
                    modal.querySelector('#shareLink').value = shareUrl;
                    
                    // è·å–æ–‡ä»¶å¤¹å¯†ç 
                    const password = await api.getFolderPassword(folderID);
                    modal.querySelector('#removePassword').checked = !password;
                    modal.querySelector('#editFolderPassword').value = '';
                    modal.querySelector('#editFolderPassword').placeholder = password ? '******' : 'ä¸è®¾ç½®åˆ™æ— éœ€å¯†ç ';
                    
                    showModal('folderSettingsModal');
                }
            } catch (error) {
                console.error('è·å–æ–‡ä»¶å¤¹ä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–æ–‡ä»¶å¤¹ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹
        async function createFolder() {
            const name = document.getElementById('newFolderName').value;
            const password = document.getElementById('newFolderPassword').value;

            if (!name) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
                return;
            }

            try {
                // åˆ›å»ºæ–‡ä»¶å¤¹
                const result = await api.createFolder(name, currentFolderID);
                
                // å¦‚æœè®¾ç½®äº†å¯†ç ï¼Œåˆ™è®¾ç½®æ–‡ä»¶å¤¹å¯†ç 
                if (password) {
                    await api.setFolderPassword(result.dirID, password);
                }
                
                // éšè—æ¨¡æ€æ¡†å¹¶åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
                hideModal('createFolderModal');
                await loadFolders();
                
                // å¦‚æœåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸­åˆ›å»ºï¼Œåˆ™åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                if (currentFolderID === result.parentID) {
                    await loadFiles(currentFolderID);
                }
            } catch (error) {
                if (error.message.includes('å·²ç»å­˜åœ¨')) {
                    alert('åˆ›å»ºå¤±è´¥ï¼šè¯¥æ–‡ä»¶å¤¹åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                } else {
                    console.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                    alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
                }
            }
        }

        // ä¿å­˜æ–‡ä»¶å¤¹è®¾ç½®
        async function saveFolderSettings() {
            const modal = document.getElementById('folderSettingsModal');
            const folderID = parseInt(modal.dataset.folderId);
            const newName = document.getElementById('editFolderName').value;
            const newPassword = document.getElementById('editFolderPassword').value;
            const removePassword = document.getElementById('removePassword').checked;

            try {
                // è·å–å½“å‰æ–‡ä»¶å¤¹ä¿¡æ¯
                const folders = await api.getFileList(0);
                const folder = folders.fileList.find(f => f.fileId === folderID);

                if (folder) {
                    // æ›´æ–°æ–‡ä»¶å¤¹åç§°
                    if (newName !== folder.filename) {
                        await api.request(`${CONFIG.API_BASE_URL}/api/v1/file/rename`, {
                            method: 'POST',
                            body: JSON.stringify({
                                renameList: [`${folderID}|${newName}`]
                            })
                        });
                    }

                    // æ›´æ–°å¯†ç 
                    if (removePassword) {
                        await api.setFolderPassword(folderID, null);
                    } else if (newPassword) {
                        await api.setFolderPassword(folderID, newPassword);
                    }

                    hideModal('folderSettingsModal');
                    await loadFolders();
                }
            } catch (error) {
                console.error('ä¿å­˜æ–‡ä»¶å¤¹è®¾ç½®å¤±è´¥:', error);
                alert('ä¿å­˜æ–‡ä»¶å¤¹è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å¤åˆ¶åˆ†äº«é“¾æ¥
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        // åˆ‡æ¢æ–‡ä»¶é€‰æ‹©
        function toggleFileSelection(fileID) {
            if (selectedFiles.has(fileID)) {
                selectedFiles.delete(fileID);
            } else {
                selectedFiles.add(fileID);
            }
        }

        // æ‰¹é‡ä¸‹è½½é€‰ä¸­æ–‡ä»¶
        async function downloadSelected() {
            if (selectedFiles.size === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }

            try {
                for (const fileID of selectedFiles) {
                    await downloadFile(fileID);
                }
            } catch (error) {
                console.error('æ‰¹é‡ä¸‹è½½å¤±è´¥:', error);
                alert('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹è½½å•ä¸ªæ–‡ä»¶
        async function downloadFile(fileID) {
            try {
                const result = await api.getDirectLink(fileID);
                if (result && result.url) {
                    const a = document.createElement('a');
                    a.href = result.url;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } else {
                    throw new Error('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤é€‰ä¸­æ–‡ä»¶
        async function deleteSelected() {
            if (selectedFiles.size === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedFiles.size} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) {
                return;
            }

            try {
                await api.request(`${CONFIG.API_BASE_URL}/api/v1/file/trash`, {
                    method: 'POST',
                    body: JSON.stringify({
                        fileIDs: Array.from(selectedFiles)
                    })
                });

                await loadFiles(currentFolderID);
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                alert('åˆ é™¤æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                pdf: 'ğŸ“„',
                doc: 'ğŸ“', docx: 'ğŸ“',
                xls: 'ğŸ“Š', xlsx: 'ğŸ“Š',
                ppt: 'ğŸ“½', pptx: 'ğŸ“½',
                jpg: 'ğŸ–¼', jpeg: 'ğŸ–¼', png: 'ğŸ–¼', gif: 'ğŸ–¼',
                zip: 'ğŸ“¦', rar: 'ğŸ“¦', '7z': 'ğŸ“¦',
                mp3: 'ğŸµ', wav: 'ğŸµ',
                mp4: 'ğŸ¥', avi: 'ğŸ¥', mov: 'ğŸ¥'
            };
            return icons[ext] || 'ğŸ“„';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }

        // æœç´¢æ–‡ä»¶
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const keyword = e.target.value.trim();
            if (keyword) {
                try {
                    const result = await api.request(
                        `${CONFIG.API_BASE_URL}/api/v2/file/list?parentFileId=${currentFolderID}&searchData=${encodeURIComponent(keyword)}`
                    );
                    updateFileGrid(result.fileList);
                } catch (error) {
                    console.error('æœç´¢æ–‡ä»¶å¤±è´¥:', error);
                }
            } else {
                await loadFiles(currentFolderID);
            }
        });

        // æ›´æ–°æ–‡ä»¶ç½‘æ ¼
        function updateFileGrid(files) {
            const fileGrid = document.getElementById('fileGrid');
            fileGrid.innerHTML = '';
            selectedFiles.clear();

            files.forEach(file => {
                if (file.type === 0) {
                    fileGrid.innerHTML += `
                        <div class="file-card" data-file-id="${file.fileId}">
                            <div class="file-actions">
                                <input type="checkbox" onchange="toggleFileSelection(${file.fileId})">
                            </div>
                            <div class="file-icon">${getFileIcon(file.filename)}</div>
                            <div class="file-name">${file.filename}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                            <button class="btn" onclick="downloadFile(${file.fileId})">ä¸‹è½½</button>
                        </div>
                    `;
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢
        init();
    </script>
</body>
</html> 